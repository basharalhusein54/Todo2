name: Verify Application Startup

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  run-application-check:
    runs-on: ubuntu-latest

    env:
      ENVIRONMENT: Testing
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      RSA_PRIVATE_KEY: ${{ secrets.RSA_PRIVATE_KEY }}
      RSA_PUBLIC_KEY: ${{ secrets.RSA_PUBLIC_KEY }}
      JWT_ALGORITHM: ${{ secrets.JWT_ALGORITHM }}
      JWT_EXP_MINUTES: ${{ secrets.JWT_EXP_MINUTES }}
      JWT_EXP_DAYS: ${{ secrets.JWT_EXP_DAYS }}

    steps:
      - name: 📦 Checkout code
        uses: actions/checkout@v4

      - name: 🐍 Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 📥 Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirpements.txt

      - name: 🚀 Start FastAPI application in background
        run: |
          uvicorn app.main:app --host 127.0.0.1 --port 8000 &
          echo $! > uvicorn_pid.txt
          sleep 5

      - name: 🧪 Wait and verify application is running
        run: |
          echo "🔍 Attempting to connect to the running application..."
          for i in {1..10}; do
            if curl -f http://127.0.0.1:8000/; then
              echo "✅ Application responded successfully."
              exit 0
            else
              echo "⏳ Waiting for app... Attempt $i"
              sleep 2
            fi
          done
          echo "❌ Application failed to respond."
          exit 1

      - name: test create user
        run: |
          curl -X POST http://localhost:8000/users/ \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            -d '{
              "username": "admin",
              "email": "admin@hotmail.com",
              "password": "12345678",
              "first_name": "admin",
              "last_name": "admin"
            }
      - name: 🔐 Test /auth/login endpoint
        run: |
          curl -X POST http://127.0.0.1:8000/auth/login \
          -H "Content-Type: application/json" \
          -d '{"username": "admin", "password": "12345678"}'

      - name: 🛑 Stop FastAPI application
        if: always()
        run: |
          echo "🔻 Stopping FastAPI..."
          kill $(cat uvicorn_pid.txt) || true
